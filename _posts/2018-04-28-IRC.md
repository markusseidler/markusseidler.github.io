---
title: "Image Recognition of Fruits with standard ML techniques"
date: 2018-05-05
tags: [machine learning, data science, image recognition]
header:
    image: "images/IRC/fruits_header.jpg"
excerpt: "Recognizing fruits with classic ML techniques"
---


## Why I am doing this?


Mainly, just for fun. I want to train a machine learning algorithm that
recognizes single fruits in a picture. I like fruits and sometimes I
encounter exotic fruits in Singapore and I have no glue what they are.
Would it not be great to have a machine learning algorithm telling you
which fruit you see?


## How am I doing this?


Good question. First, I will conduct some exploratory data analysis to
visualize an image array. I am planning to convert colored RGB images to
gray-scale for easier processing and will flatten it to a 1D array.
After that, I am thinking of using Decision Tree Classifier, Random Forest,
and Support Vector Machine algorithms. On purpose, I will not use any
neural network in this case such as Convoluational Neural Network and
TensorFlow. I want to see how far I can go by using standard classifiers.


## Should we start?


First, let's look at the underlying dataset. I use the Fruits 360 dataset
found on Kaggle.com. The dataset consists of 38,409 images of 60 fruits
from different angles. Image size is 100x100 pixels and the dataset is
divided in 28,736 images for training purpose and 9,673 images for validation.

Dataset was provided by Horea Muresan, Mihai Oltean, Fruit recognition
from images using deep learning, Technical Report, Babes-Bolyai University.
Thank you!

For example,

Bananas...


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/bananas_raw.PNG"
alt="Banana Dataset">


That was is easy. But what is this?


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/salak_raw.PNG"
alt="Salak Dataset">


You don't know meh? Salak or Snake Fruit. 蛇皮果. Try it!


## Image Arrays


Every image is a three dimensional array. While the first two dimensions
identify the location of the pixel, the third dimension indicates the
color with a value beteen 0 and 255 for Red, Green, and Blue (RGB).

The intesity of each of these three color channels can be displayed by
splitting it in three images. Each of them displays only one color channel,
Red, Green, or Blue.

This is the shape of an image with a banana. The Example array displays
the pixels in the row 50, 51, and 52 and in the column 50, 51, and 52.
Each of the pixels consist of three color channels.

<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/example_array.PNG"
alt="Example Array">

I use object-orienated programming and create a class called "ImageArray".
Within this class I write a method that takes out one of the three color
channels and puts it in to a new image.


```python

import numpy as np
import cv2

class ImageArray:
    def __init__(self, image):
        self.image = image
        self.array = np.array(self.image, dtype=np.uint8)
        self.blue, self.green, self.red = cv2.split(self.image)

    def split_color(self):

        zeros = np.zeros ([100,100],dtype=np.uint8)
        red_pic = cv2.merge([zeros, zeros, self.red])
        green_pic = cv2.merge([zeros, self.green, zeros])
        blue_pic = cv2.merge([self.blue, zeros, zeros])
        horizontal_stack = np.hstack((self.image, red_pic,
        green_pic, blue_pic))

```


Then I initiate a class with one particular image. For instance, a picture of
an apple.


```python
img = cv2.imread("../dataset/fruits-360/Training/
Apple Red 2/118_100.jpg")

apple = ImageArray(img)
```


The first image shows the original picture, the others show the same picture
by displaying only one color channel. If the color is dark, then the relevant
color channel value is closer to 0.


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/color_channels_apple.jpg"
alt="Apple Color Split">


Here is a Strawberry.


```python
img = cv2.imread("../dataset/fruits-360/Training/
Strawberry/r_252_100.jpg")

strawberry = ImageArray(img)
strawberry.split_color()
```


The strawberry is the brightest in the red channel but looks dark in
green and blue.


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/color_channels_berry.jpg"
alt="Strawberry Color Split">


For easier processing, I decided not to work with colors but to change
the images to gray scale. I add another method to my class ImageArray.


```python
    def gray(self):
        self.image_gray = cv2.cvtColor(self.image, cv2.COLOR_BGR2GRAY)
        return self.image_gray
```


Let's use an example of a Mandarine.


```python
img = cv2.imread("../dataset/fruits-360/Training/Mandarine/r_135_100.jpg")

mandarine = ImageArray(img)
mandarine.gray()
```


The class method displays the image in gray-scale.


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/gray_scale.jpg"
alt="Mandarine Gray">


I want to visualize the color distribution and choose to flatten this two
dimensional array consisting of x, y values for each pixel into a one
dimensional array. I want to see a single vector with a series of gray
color values. I write a new method to my class ImageArray.


```python
    def gray_flat(self):
        self.image_gray_flat = self.gray().flatten()

mandarine.gray_flat()
print ("\n\tOriginal shape of the image:\n\t", mandarine.image.shape)
print ("\n\tShape of the image after converting it to gray-scale:\n\t",
mandarine.image_gray.shape)
print ("\n\tShape of the image after flattening:\n\t", mandarine.image_gray_flat.shape)
```


We transformed the original 3D array to 2D and finally to 1D array with
10,000 color inputs in gray.


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/flat.png"
alt="Flattening">


Now we can display the color distribution in a KDE plot to show the
bivariate density. I also create a countplot to visualize the peaks of
the underlying color value. I use the Seaborn libary in addition to
matplotlib for a better visualization.

Just a small detail, traditionally, opencv converts images to Blue,
Green, Red arrays. In order to display them correctly in matplotlib, I
need to convert them into the standard color format Red, Green, Blue.


```python
import seaborn as sns
import matplotlib.pyplot as plt

img = cv2.imread("../dataset/fruits-360/Training/Mandarine/r_135_100.jpg")
mandarine = ImageArray(img)
img = cv2.imread("../dataset/fruits-360/Training/Strawberry/r_252_100.jpg")
strawberry = ImageArray(img)
img = cv2.imread("../dataset/fruits-360/Training/Apple Red 2/118_100.jpg")
apple = ImageArray(img)
img = cv2.imread("../dataset/fruits-360/Training/Banana/104_100.jpg")
banana = ImageArray(img)
img = cv2.imread("../dataset/fruits-360/Training/Mango/253_100.jpg")
mango = ImageArray(img)
img = cv2.imread("../dataset/fruits-360/Training/Avocado/r_19_100.jpg")
avocado = ImageArray(img)

fruits = [mandarine, strawberry, apple, banana, mango, avocado]

fig, axes = plt.subplots(nrows=len(fruits),ncols=3, figsize = (15,12))

for i, fruit in zip(range(len(fruits)), fruits):
    x = fruit.gray_flat()

    for j in range(3):
        if j == 0:
            axes[i][j].imshow(cv2.cvtColor(fruit.array,
            cv2.COLOR_BGR2RGB))
        if j == 1:
            sns.kdeplot(np.arange(len(x)),x, cmap="magma",
            shade=True, ax=axes[i][j])
            axes[i][j].set_ylim([0, 255])
        if j == 2:
            axes[i][j].tick_params(axis="x", which="both",
            bottom=False, top=False,labelbottom=False)
            axes[i][j].set_ylim([0, 200])
            sns.countplot(x, ax=axes[i][j])

axes[0][0].set_title("Original fruit image")
axes[len(fruits)-1][0].set_xlabel("Pixel")
axes[0][1].set_title("KDE plot of 1d gray-scale array")
axes[len(fruits)-1][1].set_xlabel("Pixel flattened")
axes[0][2].set_title("Countplot of gray-color intensity")
axes[len(fruits)-1][2].set_xlabel("\nGray-color intensity
0/black (left) to 255/white (right)")

fig.savefig("Image EDA.jpg")
```


I continue to use object-orientated programming and make use of the
class I created earlier called ImageArray. I then iterate through a
pre-defined list of fruits, and plot them one by one. The charts in
the middle show the KDE plot. The plot on the right axis counts the
color values.


<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/Image EDA.jpg"
alt="Image EDA">


The KDE plot is summary of a scatter plot and they all show fields of
intense color on the top left and top right side. Those fields are the
white backgroud. It can be also seen in the countplot. The bin on the
very right side shows the count of color 255. In other words, how often
does the color white appear in the image. In all case, it is a peak from
the rest of the color values. The strong distinction between the background
and the object, makes it easier for machine learning algorithms to focus
on the fruit object.


## Let's train

Now it's time to start working with machine learning algorithms. It's to
train a classifier and test its results. It's time for the fun...

Each fruit image is in a folder that is named after the fruit. In order to
train a model, we need to prepare the dataset in a array with features
called X and into a matrix with labels called y. We convert every image to
a 1d array and store it image by image, row by row in X. X will be a 2d
array where each row is a flattened image in gray-scale. y will have all
the names of those images, the label of each of these rows. In other words,
it will be a list of fruit names.

The standard libary for machine learning is scikit-learn. I choose
RandomForest as first classifier as it is a strong algorithm.


```python
import os
import glob
import cv2
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, confusion_matrix
import pandas as pd
from timeit import default_timer as timer
```

OS and glob helps me to extract the folderlist with the fruit images.
I also like to measure how long it takes to run calculations. Therefore,
I work with timeit. If you wonder how come that the calculations are soooo
fast or soooo slow, just to let you know, I will use my standard CPU for it.
Intel Core i7-7700HQ CPU @ 2.8 GHz.







# H1 Heading

## H2 Heading

### H3 Heading

Here's some basic text.


and here's some *italics*

Here's some **bold** text.

And here is a [link] (https://github.io)

Here is a bulleted list:

* First item
+ Second item
- Third item

Here is a numbered list:

1. First
2. Second
3. Third

Python code block:


```python
    import numpy as np

    def test_function (x, y):
    z = np.sum(x,y)
    return z
```



Here is some inline code "x+y"

Hier ist ein Bild

<img src="{{ site.url }}{{ site.baseurl }}/images/IRC/test.JPG" alt="banana">




